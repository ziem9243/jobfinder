<!DOCTYPE html>
<html>
<head>
  <title>Job Search</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 500px; }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">

  <!-- Top bar: auth + recruiter -->
  <div class="d-flex justify-content-end align-items-center gap-2 my-3">
    {% if user.is_authenticated %}
      <span class="me-2">Hi, {{ user.username }} ({{ user.get_role_display }})</span>

      {% if user.role == 'recruiter' %}
        <a class="btn btn-outline-primary btn-sm" href="{% url 'accounts:recruiter_dashboard' %}">Recruiter</a>
      {% endif %}

      <form method="post" action="{% url 'accounts:logout' %}" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm btn-outline-secondary">Logout</button>
      </form>
    {% else %}
      <a class="btn btn-sm btn-primary" href="{% url 'accounts:login' %}">Login</a>
      <a class="btn btn-sm btn-outline-primary" href="{% url 'accounts:register' %}">Register</a>
    {% endif %}
  </div>

  <h1 class="mb-4 text-center">Job Search</h1>

  <!-- Search Form -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="get" class="row g-3">
        <!-- Title -->
        <div class="col-md-4">
          <label for="title" class="form-label">Job Title</label>
          <input type="text" id="title" class="form-control" name="title" value="{{ request.GET.title }}">
        </div>

        <!-- Skills -->
        <div class="col-md-4">
          <label for="skills" class="form-label">Skills</label>
          <select name="skills" id="skills" class="form-select" multiple>
            {% for skill in all_skills %}
              <option value="{{ skill.id }}"
                {% if skill.id|stringformat:"s" in selected_skills %}selected{% endif %}>
                {{ skill.name }}
              </option>
            {% endfor %}
          </select>
          <small class="text-muted">Hold Cmd/Ctrl to select multiple.</small>
        </div>

        <!-- Location text -->
        <div class="col-md-4">
          <label for="location" class="form-label">Location</label>
          <input type="text" id="location" class="form-control" name="location" value="{{ request.GET.location }}">
        </div>

        <!-- Min Salary -->
        <div class="col-md-3">
          <label for="min_salary" class="form-label">Min Salary</label>
          <input type="number" id="min_salary" class="form-control" name="min_salary" step="0.01"
                 value="{{ request.GET.min_salary }}">
        </div>

        <!-- Max Salary -->
        <div class="col-md-3">
          <label for="max_salary" class="form-label">Max Salary</label>
          <input type="number" id="max_salary" class="form-control" name="max_salary" step="0.01"
                 value="{{ request.GET.max_salary }}">
        </div>

        <!-- Remote -->
        <div class="col-md-3">
          <label for="remote" class="form-label">Remote/On-site</label>
          <select name="remote" id="remote" class="form-select">
            <option value="">Any</option>
            <option value="remote" {% if request.GET.remote == "remote" %}selected{% endif %}>Remote</option>
            <option value="onsite" {% if request.GET.remote == "onsite" %}selected{% endif %}>On-site</option>
          </select>
        </div>

        <!-- Visa -->
        <div class="col-md-3">
          <label for="visa" class="form-label">Visa Sponsorship</label>
          <select name="visa" id="visa" class="form-select">
            <option value="">Any</option>
            <option value="yes" {% if request.GET.visa == "yes" %}selected{% endif %}>Yes</option>
            <option value="no" {% if request.GET.visa == "no" %}selected{% endif %}>No</option>
          </select>
        </div>

        <!-- Distance + hidden lat/lon -->
        <div class="col-md-4">
          <label for="distance" class="form-label">Distance (km)</label>
          <input type="number" id="distance" name="distance" class="form-control" value="{{ distance }}">
          <input type="hidden" id="lat" name="lat" value="{{ user_lat|default_if_none:'' }}">
          <input type="hidden" id="lon" name="lon" value="{{ user_lon|default_if_none:'' }}">
        </div>

        <!-- View Mode -->
        <div class="col-md-4">
          <label for="view" class="form-label">View Mode</label>
          <select name="view" id="view" class="form-select">
            <option value="list" {% if view_mode == "list" %}selected{% endif %}>List View</option>
            <option value="map" {% if view_mode == "map" %}selected{% endif %}>Map View</option>
          </select>
        </div>

        <!-- Buttons -->
        <div class="col-12 text-end">
          <button type="submit" class="btn btn-primary">Search</button>
          <a href="{% url 'home:index' %}" class="btn btn-secondary">Reset</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Results -->
  {% if view_mode == "list" %}
    <h2 class="mb-3">Results</h2>
    <div class="row">
      {% for job in jobs %}
        <div class="col-md-6 mb-4">
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <h5 class="card-title">{{ job.title }}</h5>
              <p class="card-text">{{ job.description|truncatewords:20 }}</p>
              <ul class="list-unstyled small text-muted mb-0">
                <li>
                  <strong>Skills:</strong>
                  {% for skill in job.skills.all %}
                    <span class="badge text-bg-secondary">{{ skill.name }}</span>
                  {% empty %}
                    <span class="text-muted">None</span>
                  {% endfor %}
                </li>
                <li><strong>Location:</strong> {{ job.location|default:"—" }}</li>
                <li>
                  <strong>Salary:</strong>
                  {% if job.min_salary or job.max_salary %}
                    ${{ job.min_salary|default:"0" }} – ${{ job.max_salary|default:"0" }}
                  {% else %}
                    —
                  {% endif %}
                </li>
                <li><strong>Remote:</strong> {{ job.remote|yesno:"Yes,No" }}</li>
                <li><strong>Visa Sponsorship:</strong> {{ job.visa_sponsorship|yesno:"Yes,No" }}</li>
                {% if job.distance_km %}
                  <li><strong>Distance:</strong> {{ job.distance_km|floatformat:1 }} km</li>
                {% endif %}
              </ul>
            </div>
          </div>
        </div>
      {% empty %}
        <p class="text-muted">No jobs found.</p>
      {% endfor %}
    </div>
  {% else %}
    <h2 class="mb-3">Map Results</h2>
    <div id="map"></div>
  {% endif %}

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const form = document.querySelector("form");

  // Try to get geolocation early (fills hidden lat/lon)
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(pos) {
      document.getElementById("lat").value = pos.coords.latitude;
      document.getElementById("lon").value = pos.coords.longitude;
    });
  }

  // If user submits before geoloc arrives, wait once then submit
  form.addEventListener("submit", function(e) {
    const lat = document.getElementById("lat").value;
    const lon = document.getElementById("lon").value;
    if (!lat || !lon) {
      e.preventDefault();
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          document.getElementById("lat").value = pos.coords.latitude;
          document.getElementById("lon").value = pos.coords.longitude;
          form.submit();
        }, function() { form.submit(); }, {timeout: 2000});
      }
    }
  });

  {% if view_mode == "map" %}
    const startLat = {{ user_lat|default:"37.7749" }};
    const startLon = {{ user_lon|default:"-122.4194" }};
    const map = L.map('map').setView(
  [startLat, startLon],
  {% if user_lat and user_lon %}10{% else %}4{% endif %}
);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    {% if user_lat and user_lon %}
      L.marker([{{ user_lat }}, {{ user_lon }}]).addTo(map).bindPopup("<b>You are here</b>");
    {% endif %}

    {% for job in jobs %}
      {% if job.latitude and job.longitude %}
        L.marker([{{ job.latitude }}, {{ job.longitude }}])
         .addTo(map)
         .bindPopup(
           "<b>{{ job.title|escapejs }}</b><br>{{ job.location|default:'—'|escapejs }}"
           + "{% if job.min_salary or job.max_salary %}<br>${{ job.min_salary|default:'0' }} – ${{ job.max_salary|default:'0' }}{% endif %}"
           + "{% if job.distance_km %}<br>{{ job.distance_km|floatformat:1 }} km away{% endif %}"
         );
      {% endif %}
    {% endfor %}
  {% endif %}
});
</script>

</body>
</html>
