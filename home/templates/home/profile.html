<!DOCTYPE html>
<html>
<head>
  <title>My Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #profileMap { height: 400px; border-radius: 0.375rem; border: 1px solid #dee2e6; }
    .map-instructions { background-color: #e7f3ff; border-left: 4px solid #0084ff; }
  </style>
</head>
<body class="bg-light">

  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="{% url 'home:index' %}">
        <i class="fas fa-briefcase me-2"></i>JobFinder
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="{% url 'home:index' %}">Browse Jobs</a>
        <a class="nav-link" href="{% url 'home:job_recommendations' %}">Recommendations</a>
        <a class="nav-link" href="{% url 'home:my_applications' %}">My Applications</a>
        <a class="nav-link active" href="{% url 'home:profile' %}">Profile</a>
        <a class="nav-link" href="{% url 'accounts:conversation_list' %}">Messages</a>
        <form method="post" action="{% url 'accounts:logout' %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-link nav-link text-white" style="border: none; background: none; padding: 0.5rem 1rem;">Logout</button>
        </form>
      </div>
    </div>
  </nav>

<div class="container py-4">

  <!-- Page Header -->
  <div class="mb-4">
    <h1 class="mb-0"><i class="fas fa-user me-2"></i>My Profile</h1>
  </div>

  <!-- Profile Form -->
  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post" class="row g-3">
        {% csrf_token %}

        <div class="col-12">
          <label class="form-label">Headline</label>
          {{ form.headline }}
        </div>

        <div class="col-12">
          <label class="form-label">Skills</label>
          {{ form.skills }}
          <small class="text-muted d-block">Hold Cmd/Ctrl to select multiple.</small>
        </div>

        <div class="col-12">
          <label class="form-label">Education</label>
          {{ form.education }}
        </div>

        <div class="col-12">
          <label class="form-label">Work Experience</label>
          {{ form.work_experience }}
        </div>

        <div class="col-12">
          <label class="form-label">Links</label>
          {{ form.links }}
        </div>

        <div class="col-12">
          <label class="form-label">Location</label>
          {{ form.location }}
        </div>

        <!-- Hidden fields for latitude and longitude -->
        {{ form.latitude }}
        {{ form.longitude }}

        <!-- Map for location selection -->
        <div class="col-12">
          <label class="form-label">Set Your Location on Map</label>
          <div class="alert alert-info map-instructions p-3 mb-3">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Click on the map to set your exact location.</strong> This will be used to calculate distances to jobs within your commute radius.
            <br><small class="text-muted mt-1 d-block">Your location will be saved automatically when you click on the map.</small>
          </div>
          <div id="profileMap"></div>
          <small class="text-muted d-block mt-2">
            <span id="locationStatus">
              {% if form.latitude.value and form.longitude.value %}
                <i class="fas fa-check-circle text-success me-1"></i>Location set: {{ form.latitude.value|floatformat:4 }}, {{ form.longitude.value|floatformat:4 }}
              {% else %}
                <i class="fas fa-exclamation-triangle text-warning me-1"></i>No location set. Click on the map to set your location.
              {% endif %}
            </span>
          </small>
        </div>

        <div class="col-12">
          <label class="form-label">Preferred Commute Radius (miles) <span class="text-muted">(Optional)</span></label>
          {{ form.commute_radius_miles }}
          <small class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            Set to 0 or leave blank for no distance limit. If set, jobs beyond this radius will be filtered out (except remote jobs).
            You can always override this by setting a specific distance when searching.
          </small>
        </div>

        <!-- Privacy Settings -->
        <div class="col-12">
          <hr>
          <h5 class="mb-3">Privacy Settings</h5>
          <p class="text-muted mb-3">Control what recruiters can see in your profile</p>
        </div>

        <div class="col-12">
          <div class="form-check">
            {{ form.profile_visible }}
            <label class="form-check-label" for="{{ form.profile_visible.id_for_label }}">
              {{ form.profile_visible.label }}
            </label>
          </div>
        </div>

        <div class="col-12">
          <div class="form-check">
            {{ form.show_headline }}
            <label class="form-check-label" for="{{ form.show_headline.id_for_label }}">
              {{ form.show_headline.label }}
            </label>
          </div>
        </div>

        <div class="col-12">
          <div class="form-check">
            {{ form.show_skills }}
            <label class="form-check-label" for="{{ form.show_skills.id_for_label }}">
              {{ form.show_skills.label }}
            </label>
          </div>
        </div>

        <div class="col-12">
          <div class="form-check">
            {{ form.show_education }}
            <label class="form-check-label" for="{{ form.show_education.id_for_label }}">
              {{ form.show_education.label }}
            </label>
          </div>
        </div>

        <div class="col-12">
          <div class="form-check">
            {{ form.show_work_experience }}
            <label class="form-check-label" for="{{ form.show_work_experience.id_for_label }}">
              {{ form.show_work_experience.label }}
            </label>
          </div>
        </div>

        <div class="col-12">
          <div class="form-check">
            {{ form.show_links }}
            <label class="form-check-label" for="{{ form.show_links.id_for_label }}">
              {{ form.show_links.label }}
            </label>
          </div>
        </div>

        <div class="col-12">
          <div class="form-check">
            {{ form.show_location }}
            <label class="form-check-label" for="{{ form.show_location.id_for_label }}">
              {{ form.show_location.label }}
            </label>
          </div>
        </div>

        <div class="col-12 text-end">
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Get the current latitude and longitude values
    const latInput = document.querySelector('input[name="latitude"]');
    const lonInput = document.querySelector('input[name="longitude"]');
    const locationStatus = document.getElementById('locationStatus');
    
    // Default location (San Francisco if no location is set)
    let defaultLat = 37.7749;
    let defaultLon = -122.4194;
    let currentLat = parseFloat(latInput.value) || defaultLat;
    let currentLon = parseFloat(lonInput.value) || defaultLon;
    
    // Initialize the map
    const map = L.map('profileMap').setView([currentLat, currentLon], latInput.value ? 13 : 10);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Current location marker
    let userMarker = null;
    
    // Add marker if location is already set
    if (latInput.value && lonInput.value) {
        userMarker = L.marker([currentLat, currentLon], {
            draggable: true
        }).addTo(map).bindPopup('<b>Your Location</b><br>Drag to adjust position');
        
        // Update coordinates when marker is dragged
        userMarker.on('dragend', function(e) {
            const newPos = e.target.getLatLng();
            updateLocation(newPos.lat, newPos.lng);
        });
    }
    
    // Add click event to map
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        // Remove existing marker
        if (userMarker) {
            map.removeLayer(userMarker);
        }
        
        // Add new marker
        userMarker = L.marker([lat, lng], {
            draggable: true
        }).addTo(map).bindPopup('<b>Your Location</b><br>Drag to adjust position').openPopup();
        
        // Update coordinates
        updateLocation(lat, lng);
        
        // Update coordinates when marker is dragged
        userMarker.on('dragend', function(e) {
            const newPos = e.target.getLatLng();
            updateLocation(newPos.lat, newPos.lng);
        });
    });
    
    // Function to update location inputs and status
    function updateLocation(lat, lng) {
        latInput.value = lat.toFixed(6);
        lonInput.value = lng.toFixed(6);
        
        locationStatus.innerHTML = `<i class="fas fa-check-circle text-success me-1"></i>Location set: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
    }
    
    // Try to get user's current location
    if (navigator.geolocation && !latInput.value) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Center map on user's location
            map.setView([lat, lng], 13);
            
            // Add marker
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            userMarker = L.marker([lat, lng], {
                draggable: true
            }).addTo(map).bindPopup('<b>Your Current Location</b><br>Drag to adjust or click elsewhere on map').openPopup();
            
            // Update coordinates
            updateLocation(lat, lng);
            
            // Update coordinates when marker is dragged
            userMarker.on('dragend', function(e) {
                const newPos = e.target.getLatLng();
                updateLocation(newPos.lat, newPos.lng);
            });
        }, function(error) {
            console.log('Geolocation error:', error.message);
        });
    }
});
</script>
</body>
</html>
